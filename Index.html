<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vinmonopolet Wine Database</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #000000;
      color: #e7e9ea;
    }
    .wine-card {
      background: #16181c;
      border: 1px solid #2f3336;
      transition: all 0.2s;
    }
    .wine-card:hover {
      background: #1c1f23;
      border-color: #1d9bf0;
    }
    .search-bar {
      background: #16181c;
      border: 1px solid #2f3336;
      color: #e7e9ea;
    }
    .search-bar:focus {
      border-color: #1d9bf0;
      outline: none;
    }
    .btn-primary {
      background: #1d9bf0;
      color: white;
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background: #1a8cd8;
    }
    .btn-secondary {
      background: #16181c;
      border: 1px solid #2f3336;
      color: #e7e9ea;
    }
    .btn-secondary:hover {
      background: #1c1f23;
    }
    .stat-card {
      background: #16181c;
      border: 1px solid #2f3336;
    }
    .badge-green {
      background: #00ba7c;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .badge-red {
      background: #f4212e;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .badge-blue {
      background: #1d9bf0;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';
    import { RefreshCw, Search, Star, Database, Filter } from 'https://esm.sh/lucide-react@0.263.1';

    console.log('Script loaded');

    const VinmonopoletDB = () => {
      console.log('Component rendering');
      
      const [wines, setWines] = useState([]);
      const [favorites, setFavorites] = useState([]);
      const [loading, setLoading] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [lastUpdate, setLastUpdate] = useState(null);
      const [activeTab, setActiveTab] = useState('browse');
      const [currentPage, setCurrentPage] = useState(1);
      const [showFilters, setShowFilters] = useState(false);
      
      // Filters
      const [filters, setFilters] = useState({
        category: 'all',
        country: 'all',
        priceMin: '',
        priceMax: '',
        inStock: false
      });

      const ITEMS_PER_PAGE = 50;

      // Load data on mount
      useEffect(() => {
        console.log('useEffect: Loading data');
        loadLocalData();
      }, []);

      const loadLocalData = async () => {
        console.log('Loading local data...');
        try {
          // Check if window.storage exists
          if (!window.storage) {
            console.log('window.storage not available, using localStorage fallback');
            const winesData = localStorage.getItem('vinm-wines-db');
            const favsData = localStorage.getItem('vinm-favorites');
            const updateData = localStorage.getItem('vinm-last-update');
            
            if (winesData) {
              const winesList = JSON.parse(winesData);
              console.log(`Loaded ${winesList.length} wines from localStorage`);
              setWines(winesList);
            }
            if (favsData) {
              setFavorites(JSON.parse(favsData));
            }
            if (updateData) {
              setLastUpdate(updateData);
            }
            return;
          }

          const winesData = await window.storage.get('vinm-wines-db');
          const favsData = await window.storage.get('vinm-favorites');
          const updateData = await window.storage.get('vinm-last-update');
          
          if (winesData?.value) {
            const winesList = JSON.parse(winesData.value);
            console.log(`Loaded ${winesList.length} wines`);
            setWines(winesList);
          } else {
            console.log('No wines data found');
          }
          if (favsData?.value) {
            setFavorites(JSON.parse(favsData.value));
          }
          if (updateData?.value) {
            setLastUpdate(updateData.value);
          }
        } catch (error) {
          console.error('Error loading data:', error);
        }
      };

      const fetchFromAPI = async () => {
        setLoading(true);
        try {
          let allProducts = [];
          let start = 0;
          const batchSize = 1000;
          let hasMore = true;
          
          while (hasMore) {
            console.log(`Fetching batch starting at ${start}...`);
            const response = await fetch(`/.netlify/functions/fetch-vinmonopolet?maxResults=${batchSize}&start=${start}`);
            const data = await response.json();
            
            if (data.error) {
              alert(`API Error: ${data.message}`);
              break;
            }
            
            if (data.products && data.products.length > 0) {
              allProducts = allProducts.concat(data.products);
              hasMore = data.hasMore;
              start += batchSize;
              console.log(`Fetched ${allProducts.length} total wines`);
            } else {
              hasMore = false;
            }
            
            // Limit to prevent excessive data
            if (allProducts.length >= 100000) {
              hasMore = false;
            }
          }
          
          if (allProducts.length > 0) {
            console.log(`Saving ${allProducts.length} wines`);
            setWines(allProducts);
            
            // Try window.storage first, fallback to localStorage
            try {
              if (window.storage) {
                await window.storage.set('vinm-wines-db', JSON.stringify(allProducts));
              } else {
                localStorage.setItem('vinm-wines-db', JSON.stringify(allProducts));
              }
            } catch (e) {
              console.error('Storage error:', e);
            }
            
            const now = new Date().toISOString();
            setLastUpdate(now);
            
            try {
              if (window.storage) {
                await window.storage.set('vinm-last-update', now);
              } else {
                localStorage.setItem('vinm-last-update', now);
              }
            } catch (e) {
              console.error('Storage error:', e);
            }
            
            alert(`âœ“ Loaded ${allProducts.length.toLocaleString()} wines`);
          }
        } catch (error) {
          alert('Failed to fetch. Check console.');
          console.error('Fetch error:', error);
        } finally {
          setLoading(false);
        }
      };

      // Filtered wines with memoization for performance
      const filteredWines = useMemo(() => {
        let result = wines;

        // Search filter
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          result = result.filter(wine => {
            const name = wine.productName || wine.name || '';
            const producer = wine.productSelection || wine.producer || '';
            const country = wine.country || '';
            return name.toLowerCase().includes(query) || 
                   producer.toLowerCase().includes(query) ||
                   country.toLowerCase().includes(query);
          });
        }

        // Category filter
        if (filters.category !== 'all') {
          result = result.filter(w => 
            (w.productType || w.category || '').toLowerCase().includes(filters.category.toLowerCase())
          );
        }

        // Country filter
        if (filters.country !== 'all') {
          result = result.filter(w => 
            (w.country || '').toLowerCase() === filters.country.toLowerCase()
          );
        }

        // Price filters
        if (filters.priceMin) {
          result = result.filter(w => (w.price || 0) >= parseFloat(filters.priceMin));
        }
        if (filters.priceMax) {
          result = result.filter(w => (w.price || 0) <= parseFloat(filters.priceMax));
        }

        // Stock filter
        if (filters.inStock) {
          result = result.filter(w => (w.stock || w.productAvailability) === 'Tilgjengelig');
        }

        return result;
      }, [wines, searchQuery, filters]);

      // Paginated wines
      const paginatedWines = useMemo(() => {
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        return filteredWines.slice(start, end);
      }, [filteredWines, currentPage]);

      const totalPages = Math.ceil(filteredWines.length / ITEMS_PER_PAGE);

      const toggleFavorite = async (wine) => {
        const wineId = wine.productId || wine.id;
        const newFavorites = favorites.includes(wineId)
          ? favorites.filter(id => id !== wineId)
          : [...favorites, wineId];
        
        setFavorites(newFavorites);
        
        try {
          if (window.storage) {
            await window.storage.set('vinm-favorites', JSON.stringify(newFavorites));
          } else {
            localStorage.setItem('vinm-favorites', JSON.stringify(newFavorites));
          }
        } catch (e) {
          console.error('Storage error:', e);
        }
      };

      // Get unique values for filters
      const uniqueCategories = useMemo(() => 
        [...new Set(wines.map(w => w.productType || w.category).filter(Boolean))].sort(),
        [wines]
      );

      const uniqueCountries = useMemo(() => 
        [...new Set(wines.map(w => w.country).filter(Boolean))].sort(),
        [wines]
      );

      const stats = useMemo(() => ({
        total: wines.length,
        favorites: favorites.length,
        inStock: wines.filter(w => (w.stock || w.productAvailability) === 'Tilgjengelig').length,
        avgPrice: wines.length > 0 
          ? (wines.reduce((sum, w) => sum + (w.price || 0), 0) / wines.length).toFixed(0)
          : 0
      }), [wines, favorites]);

      console.log(`Rendering with ${wines.length} wines, ${filteredWines.length} filtered`);

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="border-b border-gray-800 sticky top-0 z-50" style={{background: '#000000'}}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-2xl font-bold flex items-center gap-2">
                  <Database className="w-7 h-7 text-blue-400" />
                  Vinmonopolet
                </h1>
                <button
                  onClick={fetchFromAPI}
                  disabled={loading}
                  className="btn-primary px-4 py-2 rounded-full font-semibold flex items-center gap-2"
                >
                  <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                  {loading ? 'Loading...' : 'Refresh Data'}
                </button>
              </div>

              {/* Search Bar */}
              <div className="relative mb-4">
                <Search className="absolute left-4 top-3 w-5 h-5 text-gray-500" />
                <input
                  type="text"
                  placeholder="Search wines by name, producer, or country..."
                  value={searchQuery}
                  onChange={(e) => {
                    setSearchQuery(e.target.value);
                    setCurrentPage(1);
                  }}
                  className="search-bar w-full pl-12 pr-4 py-3 rounded-full text-base"
                />
              </div>

              {/* Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div className="stat-card p-3 rounded-lg">
                  <div className="text-gray-400 text-sm">Total Wines</div>
                  <div className="text-xl font-bold">{stats.total.toLocaleString()}</div>
                </div>
                <div className="stat-card p-3 rounded-lg">
                  <div className="text-gray-400 text-sm">In Stock</div>
                  <div className="text-xl font-bold text-green-400">{stats.inStock.toLocaleString()}</div>
                </div>
                <div className="stat-card p-3 rounded-lg">
                  <div className="text-gray-400 text-sm">Favorites</div>
                  <div className="text-xl font-bold text-yellow-400">{stats.favorites}</div>
                </div>
                <div className="stat-card p-3 rounded-lg">
                  <div className="text-gray-400 text-sm">Avg Price</div>
                  <div className="text-xl font-bold">{stats.avgPrice} kr</div>
                </div>
              </div>

              {/* Tabs */}
              <div className="flex gap-2">
                <button
                  onClick={() => setActiveTab('browse')}
                  className={`px-4 py-2 rounded-full font-semibold ${
                    activeTab === 'browse' ? 'btn-primary' : 'btn-secondary'
                  }`}
                >
                  Browse ({filteredWines.length.toLocaleString()})
                </button>
                <button
                  onClick={() => setActiveTab('favorites')}
                  className={`px-4 py-2 rounded-full font-semibold ${
                    activeTab === 'favorites' ? 'btn-primary' : 'btn-secondary'
                  }`}
                >
                  Favorites ({favorites.length})
                </button>
                <button
                  onClick={() => setShowFilters(!showFilters)}
                  className="btn-secondary px-4 py-2 rounded-full font-semibold flex items-center gap-2"
                >
                  <Filter className="w-4 h-4" />
                  Filters
                </button>
              </div>
            </div>
          </div>

          {/* Filters Panel */}
          {showFilters && (
            <div className="border-b border-gray-800" style={{background: '#16181c'}}>
              <div className="max-w-7xl mx-auto px-4 py-4">
                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                  <div>
                    <label className="block text-sm mb-1 text-gray-400">Category</label>
                    <select
                      value={filters.category}
                      onChange={(e) => setFilters({...filters, category: e.target.value})}
                      className="search-bar w-full px-3 py-2 rounded"
                    >
                      <option value="all">All Categories</option>
                      {uniqueCategories.map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm mb-1 text-gray-400">Country</label>
                    <select
                      value={filters.country}
                      onChange={(e) => setFilters({...filters, country: e.target.value})}
                      className="search-bar w-full px-3 py-2 rounded"
                    >
                      <option value="all">All Countries</option>
                      {uniqueCountries.map(country => (
                        <option key={country} value={country}>{country}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm mb-1 text-gray-400">Min Price</label>
                    <input
                      type="number"
                      value={filters.priceMin}
                      onChange={(e) => setFilters({...filters, priceMin: e.target.value})}
                      className="search-bar w-full px-3 py-2 rounded"
                      placeholder="0"
                    />
                  </div>
                  <div>
                    <label className="block text-sm mb-1 text-gray-400">Max Price</label>
                    <input
                      type="number"
                      value={filters.priceMax}
                      onChange={(e) => setFilters({...filters, priceMax: e.target.value})}
                      className="search-bar w-full px-3 py-2 rounded"
                      placeholder="10000"
                    />
                  </div>
                  <div>
                    <label className="block text-sm mb-1 text-gray-400">Stock</label>
                    <label className="flex items-center gap-2 mt-2">
                      <input
                        type="checkbox"
                        checked={filters.inStock}
                        onChange={(e) => setFilters({...filters, inStock: e.target.checked})}
                        className="w-4 h-4"
                      />
                      <span>In Stock Only</span>
                    </label>
                  </div>
                </div>
                <button
                  onClick={() => setFilters({category: 'all', country: 'all', priceMin: '', priceMax: '', inStock: false})}
                  className="mt-4 btn-secondary px-4 py-2 rounded-full text-sm"
                >
                  Clear Filters
                </button>
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="max-w-7xl mx-auto px-4 py-6">
            {wines.length === 0 ? (
              <div className="text-center py-12">
                <Database className="w-16 h-16 mx-auto mb-4 text-gray-600" />
                <p className="text-xl mb-2">No data loaded</p>
                <p className="text-gray-400 mb-4">Click "Refresh Data" to fetch from Vinmonopolet API</p>
              </div>
            ) : activeTab === 'browse' ? (
              <>
                {/* Wine Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                  {paginatedWines.map((wine, idx) => {
                    const wineId = wine.productId || wine.id || `wine-${idx}`;
                    const isFavorite = favorites.includes(wineId);
                    const inStock = (wine.stock || wine.productAvailability) === 'Tilgjengelig';

                    return (
                      <div key={wineId} className="wine-card p-4 rounded-lg">
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <h3 className="font-bold text-base leading-tight mb-1">
                              {wine.productName || wine.name || 'Unknown Wine'}
                            </h3>
                            <p className="text-sm text-gray-400">
                              {wine.productSelection || wine.producer || 'Unknown Producer'}
                            </p>
                          </div>
                          <button
                            onClick={() => toggleFavorite(wine)}
                            className="ml-2"
                          >
                            <Star 
                              className={`w-5 h-5 ${isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-gray-500'}`}
                            />
                          </button>
                        </div>

                        <div className="space-y-2">
                          <div className="flex justify-between items-center">
                            <span className="text-2xl font-bold">
                              {wine.price ? `${wine.price.toFixed(2)} kr` : 'N/A'}
                            </span>
                            <span className={inStock ? 'badge-green' : 'badge-red'}>
                              {inStock ? 'In Stock' : 'Out of Stock'}
                            </span>
                          </div>

                          <div className="grid grid-cols-2 gap-2 text-sm">
                            {wine.country && (
                              <div>
                                <span className="text-gray-400">Country:</span>
                                <span className="ml-1">{wine.country}</span>
                              </div>
                            )}
                            {(wine.productType || wine.category) && (
                              <div>
                                <span className="text-gray-400">Type:</span>
                                <span className="ml-1">{wine.productType || wine.category}</span>
                              </div>
                            )}
                            {wine.volume && (
                              <div>
                                <span className="text-gray-400">Volume:</span>
                                <span className="ml-1">{wine.volume}L</span>
                              </div>
                            )}
                            {wine.alcohol && (
                              <div>
                                <span className="text-gray-400">Alcohol:</span>
                                <span className="ml-1">{wine.alcohol}%</span>
                              </div>
                            )}
                          </div>

                          {wine.vintage && (
                            <div className="badge-blue inline-block">
                              Vintage {wine.vintage}
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Pagination */}
                {totalPages > 1 && (
                  <div className="flex justify-center items-center gap-2">
                    <button
                      onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                      disabled={currentPage === 1}
                      className="btn-secondary px-4 py-2 rounded-full disabled:opacity-50"
                    >
                      Previous
                    </button>
                    <span className="text-gray-400">
                      Page {currentPage} of {totalPages}
                    </span>
                    <button
                      onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                      disabled={currentPage === totalPages}
                      className="btn-secondary px-4 py-2 rounded-full disabled:opacity-50"
                    >
                      Next
                    </button>
                  </div>
                )}
              </>
            ) : (
              // Favorites Tab
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {wines.filter(w => favorites.includes(w.productId || w.id)).map((wine, idx) => {
                  const wineId = wine.productId || wine.id || `fav-${idx}`;
                  const inStock = (wine.stock || wine.productAvailability) === 'Tilgjengelig';

                  return (
                    <div key={wineId} className="wine-card p-4 rounded-lg">
                      <div className="flex justify-between items-start mb-2">
                        <div className="flex-1">
                          <h3 className="font-bold text-base leading-tight mb-1">
                            {wine.productName || wine.name || 'Unknown Wine'}
                          </h3>
                          <p className="text-sm text-gray-400">
                            {wine.productSelection || wine.producer || 'Unknown Producer'}
                          </p>
                        </div>
                        <button onClick={() => toggleFavorite(wine)}>
                          <Star className="w-5 h-5 fill-yellow-400 text-yellow-400" />
                        </button>
                      </div>

                      <div className="space-y-2">
                        <div className="flex justify-between items-center">
                          <span className="text-2xl font-bold">
                            {wine.price ? `${wine.price.toFixed(2)} kr` : 'N/A'}
                          </span>
                          <span className={inStock ? 'badge-green' : 'badge-red'}>
                            {inStock ? 'In Stock' : 'Out of Stock'}
                          </span>
                        </div>

                        {wine.country && (
                          <div className="text-sm">
                            <span className="text-gray-400">Country:</span>
                            <span className="ml-1">{wine.country}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
                {favorites.length === 0 && (
                  <div className="col-span-3 text-center py-12">
                    <Star className="w-16 h-16 mx-auto mb-4 text-gray-600" />
                    <p className="text-xl mb-2">No favorites yet</p>
                    <p className="text-gray-400">Click the star icon on wines to add them to favorites</p>
                  </div>
                )}
              </div>
            )}

            {lastUpdate && (
              <div className="text-center mt-8 text-sm text-gray-500">
                Last updated: {new Date(lastUpdate).toLocaleString()}
              </div>
            )}
          </div>
        </div>
      );
    };

    try {
      console.log('Creating React root...');
      ReactDOM.createRoot(document.getElementById('root')).render(<VinmonopoletDB />);
      console.log('React app rendered');
    } catch (error) {
      console.error('React rendering error:', error);
      document.getElementById('root').innerHTML = `
        <div style="color: white; padding: 20px;">
          <h1>Error loading app</h1>
          <p>${error.message}</p>
          <p>Check browser console for details</p>
        </div>
      `;
    }
  </script>

</body>
</html>
